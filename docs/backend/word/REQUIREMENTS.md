# Word 模块业务需求说明（REQUIREMENTS）

## 1. 目标与范围

- 目标：建立“全局词项 + 用户词网关联 + 每用户多义项（中文释义） + 关联（Associations）”的业务模型，支持用户将词项加入个人词网、为同一词项维护多个中文义项与标签/备注，并在个人词网范围内进行检索、关联与管理。
- In scope：
  - 全局词项唯一性与规范化（无用户标识、无语言维度）
  - 将词项加入/移出“我的词网”（不影响他人）
  - 每个用户可为同一词项维护多个中文义项（支持设为主义项、排序）
  - 个人化标签与备注（归属“个人词项/UserWord”或具体“个人义项/UserSense”）
  - 在“我的词网”范围内按词项与义项进行搜索（前缀/精确）
  - 关联管理（Associations）：
    - UserWordLink（词-词）：形近词、词根/词缀
    - UserSenseWordLink（义 → 词）：从某一“个人义项”指向一个“全局词项”的语义关联（同/近义、反义、相关等）
    - 关联的创建、查看/筛选、删除与幂等
- Out of scope：跨用户共享的公开关联、全网可视化；多语种义项结构与例句管理（可后续扩展）。

## 2. 角色与权限

- 登录用户（唯一角色）：
  - 可将词项加入/移出“我的词网”。
  - 可为“我的词网”中的任一词项维护多个中文义项、标签与备注（仅影响本人）。
  - 可在“我的词网”范围内创建/查看/删除与自己有关的关联。
  - 不得直接修改或删除“全局词项”本身；当全局不存在时，加入流程可触发创建全局词项。

权限要求：

- 创建/查看/更新/删除（限我的词网、我的义项与我的关联）：仅登录用户；且仅创建者可操作自己的词网记录、义项与关联。

## 3. 术语与对象

- 全局词项（Word）：
  - 面向全体用户共享的基础条目，不含用户标识与语言字段。
  - 以“规范化键（Canonical Key）”全局唯一（跨所有用户）。
- 个人词项（UserWord）：
  - 表示“某用户已将某全局词项纳入其个人词网”的事实，承载个人化信息（标签、备注、加入时间等）。
- 个人义项（UserSense）：
  - 某用户对某全局词项的一条中文义项记录；一个词项可拥有多条“个人义项”。
  - 支持设置主义项与调整义项顺序（排序）。
- 个人词关联（UserWordLink）：
  - 某用户在两个全局词项之间建立的关联；前提是两个词项均已在该用户的“我的词网”中。
  - 类型示例：similar_form（形近词）、root_affix（词根/词缀）。
- 个人义 → 词关联（UserSenseWordLink）：
  - 某用户从一个“个人义项”指向一个“全局词项”的语义关联，用于表达“这个具体意思关联到那个词”。
  - 类型示例：synonym（同/近义）、antonym（反义）、related（相关/联想）。
- 规范化键（Canonical Key）：用于唯一性与匹配（大小写不敏感、连续空白折叠、忽略首尾标点等）。

## 4. 业务规则与校验

- 词项文本（text）：必填；不得为空或仅空白；长度上限 128；不得包含不可见控制字符；用于构造规范化键。
- 全局唯一性：同一规范化键的全局词项只能存在一条（跨所有用户）。
- 加入我的词网（幂等）：
  - 若全局词项已存在：复用该全局词项，在当前用户的词网建立/确认关联（个人词项）。
  - 若全局词项不存在：先创建全局词项，再在当前用户的词网建立关联。
  - 同一用户对同一全局词项重复加入不得产生重复记录，应返回已有记录或提示“已在词网中”。
- 个人义项（多条）：
  - 定义文本为必填；长度上限可控；不得仅空白；不得包含不可见控制字符。
  - 同一用户对同一词项的义项文本不得完全重复（避免一词下相同义项的重复条目）。
  - 可设置一条为“主义项”；可对义项进行排序（例如上/下移或按权重）。
  - 义项的增删改仅影响当前用户；不影响全局与他人。
- 标签与备注：
  - 标签数量上限 20；每个长度 1..24；允许字母/数字/连字符/下划线；去重后存储。
  - 备注长度上限可控；不允许仅空白；可归属在“个人词项”层级，也可附着在具体“个人义项”上（二选一或均可，由后续设计细化）。
- 移出我的词网：
  - 仅移除用户与该全局词项的关联及其所有“个人义项”、个人化标签与备注；不影响全局词项与他人词网。
- 关联（Associations）：
  - 端点约束：
    - UserWordLink：两个端点均为全局词项，且二者均在当前用户的“我的词网”中。
    - UserSenseWordLink：源端为当前用户的“个人义项”，目标端为“全局词项”。
  - 目标词要求：UserSenseWordLink 的目标词必须与源义项所属的词不同（“关联到其它单词”）。
  - 词网一致性：
    - UserWordLink：两端目标词必须已在该用户的“我的词网”中。
    - UserSenseWordLink：目标词若尚未在该用户的“我的词网”中，创建关联时应自动将该词加入“我的词网”（创建对应 UserWord）。
  - 自链接禁止：不允许同一节点自链接（UserWordLink 的词 ≠ 词；UserSenseWordLink 的目标词 ≠ 源义项所属词）。
  - 去重规则：同一用户、同一类型、同一端点对的关联不得重复；
    - 对称类型（如 similar_form、synonym、related）：（A,B）与（B,A）视为同一条。
    - 若未来支持有向类型，应按有向对进行判定（本期缺省均视为对称）。
  - 跨层限制：
    - 语义关联（UserSenseWordLink）以“义项 → 词”的语义关系表达具体意思到目标词的联系；
    - 非语义关联（UserWordLink）基于词项本身，与具体义项无关；两类互不混用。
  - 数量上限：单端点的关联条数需设置上限（例如每类上限可配置）。
  - 附加信息：可选备注（长度上限可控，非仅空白）。
  - 级联删除：删除个人义项后，应级联删除以该义项为源端的 UserSenseWordLink 关联。

## 5. 用例与验收标准

### UC1 将词项加入“我的词网”（Add to My Network）

- 前置条件：用户已登录；输入（文本）满足基本校验。
- 主成功场景：
  1. 用户提交词项文本（可同时提交标签/备注与首条个人义项）。
  2. 系统按规范化键在全局查找：存在则复用；不存在则创建全局词项。
  3. 在当前用户的词网建立关联（个人词项）；如提供首条个人义项则一并创建。
  4. 返回个人词项详情（含全局信息 + 个人化信息 + 个人义项列表）。
- 异常场景：
  - 文本为空、超长、标签/备注不合规。
  - 已在词网中（幂等加入）。
- 验收标准：
  - 对同一文本重复加入仅返回已有记录或提示“已在词网中”。
  - 全局存在与不存在两种路径下，最终均能在“我的词网”看到该词项。

### UC2 新增个人义项（Add UserSense）

- 前置条件：用户已登录；目标词项已在“我的词网”中；义项文本满足校验。
- 主成功场景：
  1. 用户为该词项新增一条中文义项（可选是否设为主义项）。
  2. 系统校验重复与长度规则，保存成功并返回更新后的个人义项列表。
- 异常场景：
  - 目标词项不在“我的词网”中。
  - 义项文本不合法或与现有个人义项完全重复。
- 验收标准：
  - 新增后可在该词项下看到新个人义项；他人不受影响。

### UC3 更新/排序/设置主义项（Update/Reorder/Primary）

- 前置条件：用户已登录；目标个人义项属于该用户且隶属其“我的词网”。
- 主成功场景：
  1. 用户修改个人义项文本或备注；或调整排序；或将某条个人义项设置为主义项。
  2. 系统校验规则并保存，返回最新的个人义项列表与标识。
- 异常场景：
  - 非本人个人义项或目标不存在。
  - 修改后与同一词项下的其他个人义项完全重复。
- 验收标准：
  - 变更仅影响当前用户；主义项唯一且状态正确；排序结果可被稳定读取。

### UC4 删除个人义项（Remove UserSense）

- 前置条件：用户已登录；目标个人义项属于该用户且隶属其“我的词网”。
- 主成功场景：
  1. 系统删除该个人义项，若其为主义项则清除主义项标记（或按策略自动迁移）。
  2. 同时删除以该个人义项为源端的所有义 → 词关联（UserSenseWordLink）。
- 异常场景：
  - 非本人个人义项或目标不存在。
- 验收标准：
  - 删除后该个人义项不可再查看；其余个人义项与全局信息不受影响。
  - 该义项作为源端的义 → 词关联均被删除；目标词项与他人数据不受影响。

### UC5 从我的词网移除词项（Remove from My Network）

- 前置条件：用户已登录；目标词项已在“我的词网”中。
- 主成功场景：
  1. 系统移除用户与该全局词项的关联（个人词项），同时删除该用户对该词项的全部个人义项、标签与备注。
- 异常场景：
  - 目标不在“我的词网”中。
- 验收标准：
  - 移除后在“我的词网”不可检索或查看该词项；全局与他人不受影响。

### UC6 在“我的词网”内搜索（Search in My Network）

- 前置条件：用户已登录。
- 主成功场景：
  1. 用户输入查询词。
  2. 系统在“我的词网”范围内执行匹配：
     - 词项维度：按规范化规则支持前缀与精确匹配。
     - 义项维度：支持按个人义项中文文本的前缀/包含匹配（可配置）。
  3. 返回匹配列表，提供必要的分页能力。
- 验收标准：
  - 大小写不敏感、空白规范化后一致的内容应能命中。
  - 仅返回当前用户词网内的词项/个人义项结果。

### UC7 创建个人义 → 词关联（Create UserSenseWordLink）

- 前置条件：用户已登录；源端为当前用户的“个人义项”；目标端为一个“全局词项”。
- 主成功场景：
  1. 用户在“个人义项”下选择“关联到其它单词”，指定目标词与关联类型（synonym / antonym / related），可选备注。
  2. 系统校验：目标词与源义项所属词不同；未形成重复关联；未超出数量上限。
  3. 若目标词尚未在该用户的“我的词网”中，系统自动将其加入“我的词网”（创建对应 UserWord）。
  4. 创建成功并返回关联详情。
- 异常场景：
  - 目标词不存在（全局词项未找到且不允许自动创建的场景）。
  - 目标词与源义项所属词相同（自链接）。
  - 重复关联或超出上限，或类型不合法。
- 验收标准：
  - 创建后在源义项与目标词的详情中均可看到该关联（对称展示，不重复计数）。

### UC8 创建个人词关联（Create UserWordLink）

- 前置条件：用户已登录；两端词项均已在“我的词网”中。
- 主成功场景：
  1. 用户选择两个词项并指定关联类型（similar_form / root_affix），可选填写备注。
  2. 系统校验：两端均在“我的词网”；非自链接；未形成重复关联；未超出数量上限。
  3. 创建成功并返回关联详情。
- 异常场景：
  - 端点不在“我的词网”或不存在。
  - 自链接或重复关联。
  - 超出上限或类型不合法。
- 验收标准：
  - 创建后在任一端点的“我的关联”列表可见该关联（对称类型在两端均可见一次）。

### UC9 查看与筛选关联（List/Filter Associations）

- 前置条件：用户已登录；目标端点（词项或义项）属于当前用户范围。
- 主成功场景：
  1. 用户在词项或义项详情页查看其关联列表。
  2. 支持按类型（synonym/antonym/related/similar_form/root_affix）筛选与分页。
- 验收标准：
  - 仅返回与当前用户有关的关联；对称类型不重复展示。

### UC10 删除关联（Delete Association）

- 前置条件：用户已登录；关联由当前用户创建。
- 主成功场景：
  1. 用户在关联列表发起删除。
  2. 系统删除该关联，不影响端点实体与他人数据。
- 异常场景：
  - 目标不存在或不属于当前用户。
- 验收标准：
  - 删除后在相关端点的关联列表均不可见该条关联。

（可选）UC11 输入期全局存在性提示（Global Lookup Hint）

- 在 UC1 输入文本后即可获得“全局词项是否已存在”的提示，减少重复创建。

## 6. 幂等性与一致性

- 全局唯一：同一规范化键的全局词项只能存在一条（跨用户）。
- 词网加入幂等：同一用户对同一全局词项重复加入不得产生重复记录。
- 义项一致：个人义项的增删改仅影响当前用户；同一用户在同一词项下不得存在完全重复的个人义项文本。
- 关联幂等：同一用户、同类型、同端点对的关联重复创建不得产生重复记录（对称类型忽略端点顺序）。

## 7. 错误与提示（业务维度）

- 输入不合法：明确指出具体字段（词项文本、个人义项文本、标签、备注、关联类型等）的错误原因。
- 已在词网中：对已纳入词网的词项再次加入时，提示已存在或返回现有记录。
- 不在词网中：对不在词网内的词项尝试进行个人义项/标签/备注/关联操作时给出提示。
- 个人义项重复：同一词项下新增或更新导致与本人其他个人义项文本完全一致时提示重复。
- 关联错误：
  - LINK_EXISTS（关联已存在）
  - LINK_SELF_FORBIDDEN（禁止自链接）
  - LINK_TARGET_NOT_FOUND（端点不存在或不允许自动创建）
  - LINK_TYPE_INVALID（类型不合法）
  - LINK_LIMIT_EXCEEDED（超过上限）

## 8. 非功能性期望（业务层面）

- 可用性：提示信息清晰、定位问题明确；避免误操作和重复创建造成困扰。
- 一致性：规范化规则在创建、搜索与比较时保持一致；个人义项排序、主义项状态与关联展示保持一致。
- 可扩展性：未来可扩展义项的多语种与例句、以及更丰富的关联类型与可视化，而不改变既有用户体验。

## 9. 验收清单（汇总）

- 能将词项加入“我的词网”，在全局存在/不存在两种情况下均可成功（复用或创建全局词项）。
- 能为同一词项维护多条“个人义项”，支持设置主义项与调整顺序；个人义项仅影响本人。
- 能创建/查看/删除“个人义 → 词关联”和“个人词关联”，具备去重、自链接限制与分页筛选能力；创建义 → 词关联时可自动将目标词加入我的词网。
- 能更新/删除个人义项与标签/备注；删除个人词项会一并清理本人该词项的全部个人数据（含关联）。
- 在“我的词网”内可针对词项与个人义项进行搜索（大小写不敏感、支持前缀/包含），并支持分页。
- 重复加入同一词项为幂等操作；同一词项下重复个人义项文本被拒绝；关联重复创建被拒绝并提示原因。
